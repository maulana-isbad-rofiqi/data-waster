'use strict';
// Minimal frontend app (works with Cloudflare Functions KV endpoints)
const statusText = document.getElementById('statusText');
const threadCount = document.getElementById('threadCount');
const threadsRange = document.getElementById('threadsRange');
const threadsDisplay = document.getElementById('threadsDisplay');
const controlBtn = document.getElementById('controlBtn');
const stopFab = document.getElementById('stopFab');
const downValue = document.getElementById('downValue');
const upValue = document.getElementById('upValue');
const totalValue = document.getElementById('totalValue');
const logsEl = document.getElementById('logs');
const navBtns = document.querySelectorAll('.nav-item');
const pages = { home: document.getElementById('page-home'), console: document.getElementById('page-console'), settings: document.getElementById('page-settings'), about: document.getElementById('page-about') };

navBtns.forEach(btn=>btn.addEventListener('click',()=>{navBtns.forEach(b=>b.classList.remove('active'));btn.classList.add('active');const p=btn.dataset.page;Object.values(pages).forEach(pg=>pg.hidden=true);pages[p].hidden=false;document.getElementById('page-title').textContent = p==='home' ? 'Beranda' : p.charAt(0).toUpperCase()+p.slice(1);}));

const ctx = document.getElementById('netChart').getContext('2d');
const labels = Array.from({length:15},(_,i)=>i);
const data = { labels, datasets: [{label:'Unduh', data:Array(15).fill(0), borderColor:getComputedStyle(document.documentElement).getPropertyValue('--green').trim()||'#39b54a', backgroundColor:'transparent', tension:0.3, pointRadius:0},{label:'Unggah', data:Array(15).fill(0), borderColor:getComputedStyle(document.documentElement).getPropertyValue('--orange').trim()||'#ff6b35', backgroundColor:'transparent', tension:0.3, pointRadius:0}] };
const netChart = new Chart(ctx,{type:'line',data,options:{animation:false,maintainAspectRatio:false,scales:{x:{grid:{color:'rgba(255,255,255,0.02)'},ticks:{display:false}},y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.02)'}}},plugins:{legend:{display:false}}}});

let running=false;let totalBytes=0;let intervalId=null;
function formatBytes(b){if(b<1024) return b+' B'; if(b<1024*1024) return (b/1024).toFixed(2)+' KB'; return (b/(1024*1024)).toFixed(2)+' MB';}

async function persistLog(payload){
  try{ await fetch('/api/logs',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }catch(e){}
}

function renderLogLine({timestamp,type,title,msg},toTop=true){
  const el=document.createElement('div'); const cls = type==='net' ? 'log-net' : type==='error' ? 'log-error':'log-service'; el.className=`log-line ${cls}`; const timeText = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString(); el.innerText = `${timeText} ${title||''}\n${msg||''}`; if(toTop) logsEl.prepend(el); else logsEl.appendChild(el); return el;
}

function parseServerLogsAndRender(text){ if(!text) return; const lines=text.split(/\r?\n/).filter(Boolean); logsEl.innerHTML=''; lines.forEach(line=>{ const m=line.match(/^\s*\[([^\]]+)\]\s*([A-Z]+)?\s*([^-]*)-\s*(.*)$/); if(m){ const [,ts,TYPE,titleRaw,msg]=m; const typeLower=(TYPE||'INFO').toLowerCase(); let type='service'; if(typeLower.includes('net')) type='net'; else if(typeLower.includes('err')||typeLower.includes('error')||typeLower.includes('warn')) type='error'; else type='service'; renderLogLine({timestamp:ts,type,title:titleRaw.trim(),msg:msg.trim()},false);} else { renderLogLine({timestamp:null,type:'service',title:'',msg:line},false);} }); }

async function loadPersistedLogs(){ try{ const res = await fetch('/api/logs',{cache:'no-store'}); if(!res.ok) return; const text = await res.text(); parseServerLogsAndRender(text);}catch(e){} }

function setupFilterPills(){ const pillContainer=document.querySelector('.filters'); if(!pillContainer) return; const pills=Array.from(pillContainer.querySelectorAll('.pill')); let activeFilter='semua'; pills.forEach(p=>{ p.addEventListener('click',()=>{ pills.forEach(x=>x.classList.remove('active')); p.classList.add('active'); const txt=p.textContent.trim().toLowerCase(); if(txt==='semua') activeFilter='semua'; else if(txt==='info'||txt==='berhasil') activeFilter='service'; else if(txt==='peringatan'||txt==='kesalahan') activeFilter='error'; else activeFilter='semua'; Array.from(logsEl.children).forEach(lineEl=>{ if(activeFilter==='semua'){ lineEl.style.display=''; } else if(activeFilter==='service'){ lineEl.style.display = lineEl.classList.contains('log-service') ? '' : 'none'; } else if(activeFilter==='error'){ lineEl.style.display = lineEl.classList.contains('log-error') ? '' : 'none'; } else lineEl.style.display=''; }); }); }); }

async function clearLogsBoth(){ logsEl.innerHTML=''; try{ const res = await fetch('/api/clear-logs',{method:'POST'}); }catch(e){} }

function addLog(type,title,msg){ const payload={type,title,msg,timestamp:new Date().toISOString()}; renderLogLine(payload,true); persistLog(payload); }

function pushData(downKB,upKB){ const a=netChart.data.datasets[0].data, b=netChart.data.datasets[1].data; a.push(downKB); b.push(upKB); if(a.length>15){ a.shift(); b.shift(); } netChart.update(); }

function startSim(){ running=true; statusText.classList.remove('stopped'); statusText.classList.add('running'); statusText.textContent='Berjalan'; controlBtn.textContent='Hentikan ■'; controlBtn.setAttribute('aria-pressed','true'); stopFab.hidden=false; addLog('service','Service','Data wasting started'); intervalId=setInterval(()=>{ const threads=parseInt(threadsRange.value,10); const downKBs=Math.max(0,Math.round((Math.random()*900+threads*90))); const upKBs=Math.max(0,Math.round((Math.random()*150+threads*15))); pushData(downKBs,upKBs); downValue.textContent = downKBs>=1024 ? (downKBs/1024).toFixed(2)+' MB/s' : downKBs+' KB/s'; upValue.textContent = upKBs>=1024 ? (upKBs/1024).toFixed(2)+' MB/s' : upKBs+' KB/s'; totalBytes += (downKBs+upKBs)*1024; totalValue.textContent = formatBytes(totalBytes); addLog('net','Network',`Down=${downValue.textContent} Up=${upValue.textContent}\nTotal=${formatBytes(totalBytes)}`); },1000); }

function stopSim(){ running=false; statusText.classList.remove('running'); statusText.classList.add('stopped'); statusText.textContent='Berhenti'; controlBtn.textContent='Mulai ▶'; controlBtn.setAttribute('aria-pressed','false'); stopFab.hidden=true; addLog('service','Service','Data wasting stopped'); if(intervalId){ clearInterval(intervalId); intervalId=null; } }

controlBtn.addEventListener('click',()=> running? stopSim() : startSim()); stopFab.addEventListener('click',stopSim);
threadsRange && threadsRange.addEventListener('input',()=>{ threadsDisplay.textContent = threadsRange.value; threadCount.textContent = threadsRange.value; });
document.getElementById('clearLog').addEventListener('click',()=> clearLogsBoth()); document.getElementById('exportLog').addEventListener('click', async ()=>{ try{ const res = await fetch('/api/logs',{cache:'no-store'}); if(!res.ok) throw new Error('Gagal fetch logs'); const text = await res.text(); const blob = new Blob([text],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='logs.txt'; a.click(); URL.revokeObjectURL(url); }catch(e){ const lines = Array.from(logsEl.querySelectorAll('.log-line')).map(n=>n.innerText).join('\n\n'); const blob = new Blob([lines],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='logs-fallback.txt'; a.click(); URL.revokeObjectURL(url); } });
// initialize
setupFilterPills(); loadPersistedLogs();
